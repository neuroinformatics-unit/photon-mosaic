# Base paths
raw_data_base = "/nfs/winstor/margrie/SimonWeiler/RawData/Invivo_imaging/3photon_rotation/shared/"
processed_data_base = "/ceph/margrie/laura/cimaut/derivatives"

# Dynamically discover folders matching the "2*" pattern
datasets = glob_wildcards(f"{raw_data_base}{{dataset}}").dataset
datasets = [ds for ds in datasets if ds.startswith("2")]
datasets = [ds.split("/")[0] for ds in datasets]
datasets = list(set(datasets))
datasets.sort()

#  for the output
datasets_no_underscore = [ds.replace("_", "") for ds in datasets]

#  Final state of the pipeline
#  Are all the outputs files present?
rule all:
    input:
        expand(
            [
                f"{processed_data_base}/sub-{{index}}_{{datasets_no_underscore}}/ses-0/funcimg/derotation/derotated_full.tif",
                f"{processed_data_base}/sub-{{index}}_{{datasets_no_underscore}}/ses-0/funcimg/derotation/derotated_full.csv",
            ],
            zip,
            index=range(len(datasets)),
            datasets_no_underscore=datasets_no_underscore,
        )

rule preprocess:
    input:
        raw=lambda wildcards: f"{raw_data_base}{datasets[int(wildcards.index)]}/",
        # Dynamically match input files using patterns
        # bin=lambda wildcards: f"{raw_data_base}{datasets[int(wildcards.index)]}/aux_stim/*rotation_*001.bin",
        # tif=lambda wildcards: f"{raw_data_base}{datasets[int(wildcards.index)]}/imaging/rotation_*001.tif",
    output:
        tiff=f"{processed_data_base}/sub-{{index}}_{{datasets_no_underscore}}/ses-0/funcimg/derotation/derotated_full.tif",
        csv=f"{processed_data_base}/sub-{{index}}_{{datasets_no_underscore}}/ses-0/funcimg/derotation/derotated_full.csv",
    params:
        index=lambda wildcards: wildcards.index
    resources:
        partition="fast",
        mem_mb=16000,
        cpu_per_task=1,
        tasks=1,
        nodes=1,
    script:
        "../calcium_imaging_automation/core/rules/preprocess.py"
